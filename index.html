<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CFOP å…¨èƒ½è®­ç»ƒç‰ˆ (v10.0)</title>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background: #f5f5f7; color: #333; }
        * { box-sizing: border-box; }
        img { -webkit-user-drag: none; user-select: none; pointer-events: none; }

        /* å¯¼èˆªæ  */
        .navbar {
            position: sticky; top: 0; z-index: 999;
            background: rgba(255,255,255,0.98);
            padding: 12px 20px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-center { display: flex; gap: 15px; }
        .nav-btn { 
            padding: 8px 24px; border-radius: 6px; border: 1px solid #ccc; 
            background: white; cursor: pointer; font-weight: bold; font-size: 15px;
        }
        .nav-btn.active { background: #007aff; color: white; border-color: #007aff; }
        .backup-area { display: flex; gap: 10px; }
        .btn-backup { font-size: 13px; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; background: #f9f9f9; cursor: pointer; }

        /* æ•´ç†é¡µ */
        #page-manage { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex; gap: 15px; justify-content: center; align-items: center; padding: 15px; background: #fff;
            border-bottom: 1px dashed #ddd; flex-wrap: wrap; border-radius: 8px; margin-bottom: 20px;
        }
        .tool-btn { color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .sel-info { font-size: 14px; color: #666; font-weight: bold; margin-right: 15px;}

        /* åˆ†ç»„ */
        .group-section {
            background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .group-section.drag-over-group { background-color: #e3f2fd; border: 2px dashed #2196f3; }

        .group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 12px; border-bottom: 2px solid #f0f0f0; margin-bottom: 15px;
        }
        .group-title { font-size: 20px; font-weight: bold; color: #333; cursor: pointer; border-bottom: 1px dashed #ccc; }
        .btn-sm { padding: 5px 10px; font-size: 13px; border: 1px solid #eee; background: #f9f9f9; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .btn-deselect { color: #d63031; border-color: #d63031; background: #fff5f5; }

        /* ç½‘æ ¼ */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 15px; 
            min-height: 60px; 
        }
        
        .item {
            border: 2px solid transparent; border-radius: 8px; padding: 10px; text-align: center; cursor: grab; 
            background: #fff; transition: transform 0.1s; position: relative;
        }
        .item:active { cursor: grabbing; }
        .item.selected { border-color: #34c759; background: #eaffea; }
        .item.selected::after {
            content: 'âœ“'; position: absolute; top: -8px; right: -8px;
            background: #34c759; color: white; width: 24px; height: 24px; 
            border-radius: 50%; font-size: 14px; line-height: 24px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .item.dragging { opacity: 0.4; border: 2px dashed #999; transform: scale(0.95); }
        .item img { width: 100%; height: auto; display: block; pointer-events: none; margin-bottom: 5px;}
        
        /* å…¬å¼è¾“å…¥æ¡† */
        .alg-input {
            width: 100%; height: 50px; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 13px; font-weight: 500; color: #004085;
            border: 1px solid #eee; background: #fafafa; border-radius: 6px; padding: 4px;
            text-align: center; letter-spacing: 0.5px;
            resize: none; overflow: hidden; line-height: 1.3;
        }
        .alg-input:focus { background: white; border-color: #007aff; outline: none; }

        /* ç±»å‹æ ‡ç­¾ (OLL/PLL) */
        .type-tag { font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 2px; }

        /* èƒŒè¯µé¡µ */
        #page-quiz { display: none; min-height: 85vh; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .card { 
            background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 450px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; 
        }
        
        .img-box { width: 250px; height: 250px; margin: 0 auto 25px; display: flex; align-items: center; justify-content: center; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; }
        
        .ans-box { display: none; background: #f0f4f8; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; border: 1px solid #dbeafe; }
        .origin-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;}
        .origin-img { width: 80px; height: 80px; border: 2px solid #fff; background: white; padding: 2px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .origin-label { font-size: 14px; color: #7f8c8d; }

        .ans-txt { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-weight: 600; color: #003366; font-size: 32px; line-height: 1.5; 
            letter-spacing: 2px; word-break: break-word; white-space: pre-wrap; 
            margin-top: 15px; padding-top: 15px; border-top: 2px solid #dae1e7; 
        }
        
        .btn-row { display: flex; gap: 20px; margin-top: 10px;}
        .btn-act { flex: 1; padding: 16px; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 18px; cursor: pointer; transition: opacity 0.2s; }
        .btn-act:active { opacity: 0.8; }

        @media (max-width: 768px) {
            .navbar { padding: 10px; }
            .nav-btn { padding: 6px 12px; font-size: 14px; }
            .backup-area .btn-backup { padding: 4px 8px; font-size: 12px; }
            #page-manage { padding: 10px; }
            .group-section { padding: 10px; }
            .grid { grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; }
            .item { padding: 4px; }
            .item.selected::after { width: 16px; height: 16px; font-size: 10px; line-height: 16px; top: -5px; right: -5px; }
            .alg-input { height: 40px; font-size: 10px; padding: 2px; line-height: 1.1; }
            .toolbar { padding: 10px; gap: 8px; }
            .tool-btn { padding: 8px 12px; font-size: 13px; }
            .card { padding: 20px; }
            .img-box { width: 100%; max-width: 250px; aspect-ratio: 1/1; margin-bottom: 15px;}
            .ans-txt { font-size: 24px; letter-spacing: 1px; }
            .btn-act { padding: 14px; font-size: 16px; }
            .drag-hint-text { display: none; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <div style="font-weight:bold; color:#007aff; font-size:18px;">CFOP V10</div>
        <div class="nav-center">
            <button id="nav-1" class="nav-btn active" onclick="switchPage(1)">æ•´ç†</button>
            <button id="nav-2" class="nav-btn" onclick="switchPage(2)">èƒŒè¯µ</button>
        </div>
        <div class="backup-area">
            <button class="btn-backup" onclick="exportData()">ğŸ’¾ å¤‡ä»½</button>
            <button class="btn-backup" onclick="document.getElementById('file-in').click()">ğŸ“‚ æ¢å¤</button>
            <input type="file" id="file-in" style="display:none" accept=".json" onchange="importData(this)">
        </div>
    </div>

    <!-- 1. æ•´ç† -->
    <div id="page-manage">
        <div class="toolbar">
            <div class="sel-info">å·²é€‰ <span id="sel-count" style="color:#007aff; font-weight:bold;">0</span></div>
            <button class="tool-btn" style="background:#007aff" onclick="moveSelectedToNewGroup()">+ å»ºç»„</button>
            <button class="tool-btn" style="background:#ff9500" onclick="moveSelectedToDefault()">â†© é€€ç»„</button>
            <button class="tool-btn" style="background:#ff3b30" onclick="clearSelection()">âŒ å–æ¶ˆ</button>
        </div>
        
        <p class="drag-hint-text" style="text-align:center; font-size:12px; color:#999; margin-top:5px;">æç¤ºï¼šæŒ‰ä½å›¾ç‰‡å¯ç›´æ¥æ‹–æ‹½æ’åº (ç”µè„‘ç«¯)</p>
        <div id="groups-container"></div>
    </div>

    <!-- 2. èƒŒè¯µ -->
    <div id="page-quiz">
        <div class="card">
            <div class="img-box"><img id="q-img" src=""></div>
            <div id="ans-area" class="ans-box">
                <div id="q-title" style="font-weight:bold; margin-bottom:10px; font-size:18px; color:#333;"></div>
                
                <div class="origin-wrapper">
                    <span class="origin-label">æ ‡å‡†æ–¹å‘:</span>
                    <img id="ans-origin-img" class="origin-img" src="">
                </div>

                <div id="q-alg" class="ans-txt"></div>
            </div>
            <div class="btn-row">
                <button class="btn-act" style="background:#f39c12" onclick="showAns()">ğŸ‘€ ç­”æ¡ˆ</button>
                <button class="btn-act" style="background:#34c759" onclick="nextCard()">â¡ï¸ ä¸‹ä¸€ä¸ª</button>
            </div>
        </div>
        <p style="color:#999; font-size:12px; margin-top:20px;">(OLL/PLL æ··åˆè®­ç»ƒ)</p>
    </div>

    <script>
        // === 1. åˆå§‹åŒ–æ•°æ®æ„å»º ===
        // OLL 1-57 (æ•°å­—ID)
        const ollDb = Array.from({length: 57}, (_, i) => ({ id: i+1, type: 'OLL' }));
        // PLL 1-21 (å­—ç¬¦ä¸²ID "pll1" - "pll21")
        const pllDb = Array.from({length: 21}, (_, i) => ({ id: "pll" + (i+1), type: 'PLL' }));
        
        // åˆå¹¶æ•°æ®åº“
        const fullDb = [...ollDb, ...pllDb];

        let groups = [], algs = {}, currentSelectedIds = [], dragSrcId = null, dragSrcGroupId = null;

        function init() {
            try {
                // è¯»å–æ—§æ•°æ® (keyä¸å˜ï¼Œä¿è¯å‡çº§åæ•°æ®ä¸ä¸¢)
                algs = JSON.parse(localStorage.getItem('cfop_algs_v7')) || {};
                const savedGroups = localStorage.getItem('cfop_groups_v7');
                
                if (savedGroups) {
                    groups = JSON.parse(savedGroups);
                    // ã€æ™ºèƒ½å‡çº§é€»è¾‘ã€‘
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ PLL è¿˜æ²¡åœ¨ä»»ä½•ç»„é‡Œ
                    // è·å–å½“å‰æ‰€æœ‰åœ¨ç»„é‡Œçš„ID
                    const allGroupedIds = new Set();
                    groups.forEach(g => g.items.forEach(id => allGroupedIds.add(id)));
                    
                    // æ‰¾å‡ºç¼ºå°‘çš„ID (å³æ–°åŠ çš„ PLL)
                    const missingIds = fullDb.filter(x => !allGroupedIds.has(x.id)).map(x => x.id);
                    
                    if (missingIds.length > 0) {
                        // æ‰¾åˆ°é»˜è®¤ç»„ï¼ŒæŠŠç¼ºå°‘çš„åŠ è¿›å»
                        let defGroup = groups.find(g => g.id === 'default');
                        if (!defGroup) {
                            defGroup = { id: "default", name: "æœªåˆ†ç»„", items: [] };
                            groups.push(defGroup);
                        }
                        defGroup.items.push(...missingIds);
                        // ä¿å­˜æ›´æ–°
                        saveData();
                    }
                } else {
                    // ç¬¬ä¸€æ¬¡ä½¿ç”¨
                    groups = [{ id: "default", name: "æœªåˆ†ç»„", items: fullDb.map(x => x.id) }];
                }
            } catch(e) { console.error(e); }
            renderAll();
        }

        // è¾…åŠ©ï¼šè·å–æ˜¾ç¤ºåç§°
        function getDisplayName(id) {
            const strId = String(id);
            if (strId.startsWith("pll")) {
                return "PLL " + strId.replace("pll", "");
            }
            return "OLL " + id;
        }

        // è¾…åŠ©ï¼šè·å–å›¾ç‰‡æ–‡ä»¶å
        function getImgName(id) {
            return id + ".png"; // 1.png æˆ– pll1.png
        }

        function renderAll() {
            const container = document.getElementById('groups-container');
            container.innerHTML = "";
            document.getElementById('sel-count').innerText = currentSelectedIds.length;

            groups.forEach((group) => {
                const section = document.createElement('div');
                section.className = 'group-section';
                section.dataset.groupId = group.id;

                const isAllSelected = group.items.length > 0 && group.items.every(id => currentSelectedIds.includes(id));
                const selectBtnText = isAllSelected ? "å–æ¶ˆ" : "å…¨é€‰";
                const selectBtnClass = isAllSelected ? "btn-sm btn-deselect" : "btn-sm";

                let controlsHtml = `
                    <button class="btn-sm" onclick="moveGroupUp('${group.id}')">â¬†</button>
                    <button class="btn-sm" onclick="moveGroupDown('${group.id}')">â¬‡</button>
                    <button class="${selectBtnClass}" style="margin-left:5px" onclick="toggleGroupSelect('${group.id}')">${selectBtnText}</button>
                `;
                if (group.id !== 'default') controlsHtml += `<button class="btn-sm" style="color:red; border-color:#ffcccc;" onclick="deleteGroup('${group.id}')">åˆ </button>`;
                
                section.innerHTML = `<div class="group-header"><span class="group-title" onclick="renameGroup('${group.id}')">${group.name}</span><div>${controlsHtml}</div></div>`;

                const grid = document.createElement('div');
                grid.className = 'grid';
                grid.ondragover = (e) => handleDragOver(e, grid);
                grid.ondragleave = (e) => handleDragLeave(e, grid);
                grid.ondrop = (e) => handleDropOnGroup(e, group.id);

                if (group.items.length === 0) {
                    grid.innerHTML = `<div style="color:#ccc; grid-column:1/-1; padding:10px; font-size:12px;">(ç©º)</div>`;
                } else {
                    group.items.forEach(itemId => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = currentSelectedIds.includes(itemId) ? 'item selected' : 'item';
                        itemDiv.id = `item-${itemId}`;
                        itemDiv.draggable = true;
                        itemDiv.dataset.id = itemId;
                        itemDiv.dataset.groupId = group.id;
                        itemDiv.ondragstart = (e) => handleDragStart(e, itemId, group.id);
                        itemDiv.ondragend = (e) => handleDragEnd(e);
                        itemDiv.ondrop = (e) => { e.stopPropagation(); handleDropOnItem(e, itemId, group.id); };

                        const showAlg = algs[itemId] || "";
                        const showName = getDisplayName(itemId);
                        const imgFile = getImgName(itemId);

                        itemDiv.innerHTML = `
                            <div onclick="toggleSelect('${itemId}')"><img src="${imgFile}" onerror="this.src='//via.placeholder.com/100?text=${itemId}'"></div>
                            <textarea class="alg-input" onchange="saveAlg('${itemId}', this.value)" placeholder="å…¬å¼">${showAlg}</textarea>
                            <div class="type-tag">${showName}</div>
                        `;
                        grid.appendChild(itemDiv);
                    });
                }
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        // æ‹–æ‹½é€»è¾‘
        function handleDragStart(e, id, groupId) { dragSrcId = id; dragSrcGroupId = groupId; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); setTimeout(() => e.target.style.opacity='0.4', 0); }
        function handleDragEnd(e) { e.target.style.opacity='1'; document.querySelectorAll('.drag-over-group').forEach(el => el.classList.remove('drag-over-group')); }
        function handleDragOver(e, el) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; if (el.classList.contains('grid')) el.parentElement.classList.add('drag-over-group'); }
        function handleDragLeave(e, el) { if (el.classList.contains('grid')) el.parentElement.classList.remove('drag-over-group'); }
        function handleDropOnItem(e, targetId, targetGroupId) { e.preventDefault(); if (dragSrcId === null || dragSrcId === targetId) return; moveItemLogic(dragSrcId, dragSrcGroupId, targetId, targetGroupId); }
        function handleDropOnGroup(e, targetGroupId) { e.preventDefault(); if (dragSrcId === null) return; moveItemLogic(dragSrcId, dragSrcGroupId, null, targetGroupId); }
        function moveItemLogic(itemId, srcGroupId, targetItemId, targetGroupId) {
            const srcGroup = groups.find(g => g.id === srcGroupId);
            const targetGroup = groups.find(g => g.id === targetGroupId);
            // å…¼å®¹æ•°å­—å’Œå­—ç¬¦ä¸²IDæ¯”è¾ƒ
            srcGroup.items = srcGroup.items.filter(x => String(x) !== String(itemId));
            if (targetItemId) { 
                const idx = targetGroup.items.findIndex(x => String(x) === String(targetItemId));
                targetGroup.items.splice(idx, 0, itemId); 
            }
            else { targetGroup.items.push(itemId); }
            saveData(); renderAll();
        }

        // å¸¸è§„é€»è¾‘
        function moveGroupUp(id) { const i = groups.findIndex(g=>g.id===id); if(i>0) { [groups[i],groups[i-1]]=[groups[i-1],groups[i]]; saveData(); renderAll(); } }
        function moveGroupDown(id) { const i = groups.findIndex(g=>g.id===id); if(i<groups.length-1) { [groups[i],groups[i+1]]=[groups[i+1],groups[i]]; saveData(); renderAll(); } }
        
        function moveSelectedToNewGroup() { if(!currentSelectedIds.length) return alert("è¯·å…ˆå‹¾é€‰"); const n=prompt("æ–°åˆ†ç»„åï¼š"); if(!n) return; groups.forEach(g=>g.items=g.items.filter(id=>!currentSelectedIds.includes(id))); groups.unshift({id:"g_"+Date.now(), name:n, items:[...currentSelectedIds]}); currentSelectedIds=[]; saveData(); renderAll(); }
        
        function moveSelectedToDefault() { if(!currentSelectedIds.length) return alert("è¯·å‹¾é€‰"); groups.forEach(g=>{if(g.id!=='default')g.items=g.items.filter(id=>!currentSelectedIds.includes(id))}); const d=groups.find(g=>g.id==='default'); d.items=[...new Set([...d.items,...currentSelectedIds])]; currentSelectedIds=[]; saveData(); renderAll(); }
        
        function toggleSelect(id) { 
            // ç»Ÿä¸€è½¬å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œé˜²æ­¢ç±»å‹ä¸åŒ¹é…
            if(currentSelectedIds.some(x => String(x) === String(id))) 
                currentSelectedIds = currentSelectedIds.filter(x => String(x) !== String(id));
            else 
                currentSelectedIds.push(id); 
            renderAll(); 
        }
        function toggleGroupSelect(gid) {
            const g = groups.find(x => x.id === gid); if(!g) return;
            const isAll = g.items.length > 0 && g.items.every(id => currentSelectedIds.includes(id));
            if (isAll) currentSelectedIds = currentSelectedIds.filter(id => !g.items.includes(id));
            else currentSelectedIds = [...currentSelectedIds, ...g.items.filter(id => !currentSelectedIds.includes(id))];
            renderAll();
        }
        function clearSelection() { currentSelectedIds=[]; renderAll(); }
        function selectAllInGroup(gid) { const g=groups.find(x=>x.id===gid); if(g){currentSelectedIds=[...new Set([...currentSelectedIds,...g.items])]; renderAll();} }
        function renameGroup(id) { if(id==='default')return; const g=groups.find(x=>x.id===id); const v=prompt("ä¿®æ”¹åç§°",g.name); if(v){g.name=v;saveData();renderAll();} }
        function deleteGroup(id) { if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ"))return; const g=groups.find(x=>x.id===id); const d=groups.find(x=>x.id==='default'); d.items=[...new Set([...d.items,...g.items])]; groups=groups.filter(x=>x.id!==id); saveData(); renderAll(); }
        
        function exportData() { const b=new Blob([JSON.stringify({version:"10.0", date:new Date().toLocaleString(), groups, algs},null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="CFOP_Backup.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function importData(input) { 
            const f=input.files[0]; if(!f)return; 
            const r=new FileReader(); 
            r.onload=e=>{
                try{
                    const d=JSON.parse(e.target.result);
                    if(d.groups){
                        if(confirm("æ¢å¤æ•°æ®ï¼Ÿ")){
                            groups=d.groups; 
                            algs=d.algs || {}; 
                            saveData(); 
                            localStorage.setItem('cfop_algs_v7', JSON.stringify(algs));
                            renderAll();
                            alert("å®Œæˆ");
                        }
                    }
                } catch(err){alert("æ–‡ä»¶é”™è¯¯");}
            }; 
            r.readAsText(f); input.value=""; 
        }
        
        function saveAlg(id,v) { algs[id]=v; localStorage.setItem('cfop_algs_v7',JSON.stringify(algs)); }
        function saveData() { localStorage.setItem('cfop_groups_v7',JSON.stringify(groups)); }

        // èƒŒè¯µ
        function switchPage(p) { document.getElementById('page-manage').style.display = p===1 ? 'block' : 'none'; document.getElementById('page-quiz').style.display = p===2 ? 'flex' : 'none'; document.getElementById('nav-1').className = p===1 ? 'nav-btn active' : 'nav-btn'; document.getElementById('nav-2').className = p===2 ? 'nav-btn active' : 'nav-btn'; if(p===2) nextCard(); }
        function nextCard() {
            if(currentSelectedIds.length === 0) { alert("è¯·å…ˆå‹¾é€‰å›¾ç‰‡"); switchPage(1); return; }
            document.getElementById('ans-area').style.display = 'none';
            const randId = currentSelectedIds[Math.floor(Math.random() * currentSelectedIds.length)];
            const alg = algs[randId] || "æœªè®¾ç½®å…¬å¼";
            const img = document.getElementById('q-img');
            img.style.transition = 'none'; img.style.transform = 'rotate(0deg)'; 
            img.src = getImgName(randId); 
            void img.offsetWidth;
            const deg = Math.floor(Math.random() * 4) * 90;
            img.style.transform = `rotate(${deg}deg)`;
            
            const dispName = getDisplayName(randId);
            document.getElementById('q-title').innerText = `${dispName}` + (deg?` (è½¬${deg}Â°)`:'');
            document.getElementById('q-alg').innerText = alg;
            document.getElementById('ans-origin-img').src = getImgName(randId);
        }
        function showAns() { document.getElementById('ans-area').style.display = 'block'; }

        init();
    </script>
</body>
</html>