<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CFOP å¸ƒå±€ä¼˜åŒ–ç‰ˆ (v12.1)</title>
    <style>
        /* === åŸºç¡€æ ·å¼ === */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background: #f5f5f7; color: #333; height: 100vh; display: flex; flex-direction: column; }
        * { box-sizing: border-box; }
        img { -webkit-user-drag: none; user-select: none; pointer-events: none; }

        /* å¯¼èˆªæ  */
        .navbar {
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            z-index: 999;
            background: rgba(255,255,255,0.98);
            padding: 12px 20px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-center { display: flex; gap: 15px; }
        .nav-btn { 
            padding: 8px 24px; border-radius: 6px; border: 1px solid #ccc; 
            background: white; cursor: pointer; font-weight: bold; font-size: 15px;
        }
        .nav-btn.active { background: #007aff; color: white; border-color: #007aff; }
        .backup-area { display: flex; gap: 10px; }
        .btn-backup { font-size: 13px; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; background: #f9f9f9; cursor: pointer; }

        /* æ•´ç†é¡µ (å…è®¸é¡µé¢æ»šåŠ¨) */
        #page-manage { flex: 1; overflow-y: auto; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex; gap: 12px; justify-content: center; align-items: center; padding: 15px; background: #fff;
            border-bottom: 1px dashed #ddd; flex-wrap: wrap; border-radius: 8px; margin-bottom: 20px;
            transition: all 0.3s;
        }
        body.edit-mode-active .toolbar { border: 2px solid #f1c40f; background: #fffdf0; }
        .tool-btn { color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .sel-info { font-size: 14px; color: #666; font-weight: bold; margin-right: 15px;}
        .btn-toggle-edit { background: #fff; border: 1px solid #ccc; color: #555; }
        body.edit-mode-active .btn-toggle-edit { background: #f1c40f; border-color: #f39c12; color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }

        /* åˆ†ç»„ */
        .group-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; transition: background-color 0.2s; }
        .group-section.drag-over-group { background-color: #e3f2fd; border: 2px dashed #2196f3; }
        .group-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 2px solid #f0f0f0; margin-bottom: 15px; }
        .group-title { font-size: 20px; font-weight: bold; color: #333; cursor: pointer; border-bottom: 1px dashed #ccc; }
        .btn-sm { padding: 5px 10px; font-size: 13px; border: 1px solid #eee; background: #f9f9f9; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .btn-deselect { color: #d63031; border-color: #d63031; background: #fff5f5; }

        /* ç½‘æ ¼ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; min-height: 60px; }
        .item { border: 2px solid transparent; border-radius: 8px; padding: 10px; text-align: center; cursor: grab; background: #fff; transition: transform 0.1s; position: relative; }
        .item:active { cursor: grabbing; }
        .item.selected { border-color: #34c759; background: #eaffea; }
        .item.selected::after { content: 'âœ“'; position: absolute; top: -8px; right: -8px; background: #34c759; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 14px; line-height: 24px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .item.dragging { opacity: 0.4; border: 2px dashed #999; transform: scale(0.95); }
        .item-img-box { position: relative; width: 100%; height: auto; margin-bottom: 5px; transition: transform 0.2s; }
        .item img { width: 100%; height: auto; display: block; pointer-events: none; }
        .btn-rotate { display: none; position: absolute; bottom: 0; right: 0; width: 28px; height: 28px; background: rgba(241, 196, 15, 0.9); color: white; border-radius: 50%; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        body.edit-mode-active .btn-rotate { display: flex; }
        .name-tag { font-size: 11px; color: #666; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; padding: 2px 6px; border-radius: 4px; background: #f0f0f0; display: inline-block; border: 1px solid transparent; pointer-events: none; }
        body.edit-mode-active .name-tag { pointer-events: auto; cursor: pointer; background: #fff; border: 1px dashed #f39c12; color: #f39c12; }
        .alg-input { width: 100%; height: 50px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 13px; font-weight: 500; color: #004085; border: 1px solid #eee; background: #fafafa; border-radius: 6px; padding: 4px; text-align: center; letter-spacing: 0.5px; resize: none; overflow: hidden; line-height: 1.3; }
        .alg-input:focus { background: white; border-color: #007aff; outline: none; }

        /* === èƒŒè¯µé¡µ (æ ¸å¿ƒä¼˜åŒ–ï¼šFlexå…¨å±å¸ƒå±€) === */
        #page-quiz { 
            display: none; 
            flex: 1; /* å æ»¡å‰©ä½™é«˜åº¦ */
            overflow: hidden; /* é˜²æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ */
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 450px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            text-align: center;
            
            /* å…³é”®ï¼šå¡ç‰‡å†…éƒ¨ä¹Ÿç”¨ Flexï¼Œä¸”é«˜åº¦è‡ªé€‚åº” */
            display: flex;
            flex-direction: column;
            max-height: 100%; /* ä¸è¶…è¿‡å±å¹• */
        }
        
        /* ä¸­é—´å†…å®¹åŒºåŸŸï¼šå¯æ»šåŠ¨ï¼Œå æ®å‰©ä½™ç©ºé—´ */
        .card-body {
            flex: 1;
            overflow-y: auto; /* å†…å®¹å¤šäº†è¿™é‡Œæ»šï¼ŒæŒ‰é’®ä¸åŠ¨ */
            display: flex;
            flex-direction: column;
            justify-content: center; /* å†…å®¹å°‘æ—¶å±…ä¸­ */
            min-height: 0; /* Firefoxå…¼å®¹æ€§ */
        }

        .img-box { width: 100%; max-width: 250px; height: auto; aspect-ratio: 1/1; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; }
        
        .ans-box { display: none; background: #f0f4f8; padding: 20px; border-radius: 12px; margin-bottom: 10px; text-align: center; border: 1px solid #dbeafe; flex-shrink: 0; }
        .origin-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;}
        .origin-img { width: 80px; height: 80px; border: 2px solid #fff; background: white; padding: 2px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .origin-label { font-size: 14px; color: #7f8c8d; }
        .ans-txt { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-weight: 600; color: #003366; font-size: 32px; line-height: 1.5; letter-spacing: 2px; word-break: break-word; white-space: pre-wrap; margin-top: 15px; padding-top: 15px; border-top: 2px solid #dae1e7; }
        
        /* æŒ‰é’®åŒºåŸŸï¼šå›ºå®šåœ¨å¡ç‰‡åº•éƒ¨ */
        .btn-row { 
            display: flex; gap: 15px; margin-top: 10px; flex-shrink: 0; 
            padding-top: 10px; border-top: 1px solid transparent; /* é¢„ç•™ */
        }
        .btn-act { flex: 1; padding: 16px; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 18px; cursor: pointer; transition: opacity 0.2s; }
        .btn-act:active { opacity: 0.8; }

        @media (max-width: 768px) {
            .navbar { padding: 10px; }
            .nav-btn { padding: 6px 12px; font-size: 14px; }
            .backup-area .btn-backup { padding: 4px 8px; font-size: 12px; }
            
            #page-manage { padding: 10px; }
            .group-section { padding: 10px; }
            .grid { grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; }
            .item { padding: 4px; }
            .item.selected::after { width: 16px; height: 16px; font-size: 10px; line-height: 16px; top: -5px; right: -5px; }
            .alg-input { height: 40px; font-size: 10px; padding: 2px; line-height: 1.1; }
            .toolbar { padding: 10px; gap: 8px; }
            .tool-btn { padding: 8px 12px; font-size: 13px; }
            
            /* æ‰‹æœºç«¯èƒŒè¯µé¡µä¼˜åŒ– */
            #page-quiz { padding: 10px; height: calc(100vh - 55px); } /* æ‰£æ‰å¯¼èˆªæ é«˜åº¦ */
            .card { padding: 15px; height: 100%; justify-content: space-between; border-radius: 12px; }
            .card-body { justify-content: center; } /* é»˜è®¤å±…ä¸­ */
            
            .img-box { margin-bottom: 10px; max-height: 40vh; }
            .ans-box { padding: 15px; }
            .ans-txt { font-size: 26px; letter-spacing: 1px; }
            .btn-act { padding: 14px; font-size: 16px; }
            .name-tag { font-size: 9px; padding: 1px 4px; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <div style="font-weight:bold; color:#007aff; font-size:18px;">CFOP V12.1</div>
        <div class="nav-center">
            <button id="nav-1" class="nav-btn active" onclick="switchPage(1)">æ•´ç†</button>
            <button id="nav-2" class="nav-btn" onclick="switchPage(2)">èƒŒè¯µ</button>
        </div>
        <div class="backup-area">
            <button class="btn-backup" onclick="exportData()">ğŸ’¾ å¤‡ä»½</button>
            <button class="btn-backup" onclick="document.getElementById('file-in').click()">ğŸ“‚ æ¢å¤</button>
            <input type="file" id="file-in" style="display:none" accept=".json" onchange="importData(this)">
        </div>
    </div>

    <!-- 1. æ•´ç† -->
    <div id="page-manage">
        <div class="toolbar">
            <div class="sel-info">å·²é€‰ <span id="sel-count" style="color:#007aff; font-weight:bold;">0</span></div>
            <button class="tool-btn btn-toggle-edit" id="btn-edit-mode" onclick="toggleEditMode()">ğŸ”§ ç¼–è¾‘æ¨¡å¼: OFF</button>
            <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
            <button class="tool-btn" style="background:#007aff" onclick="moveSelectedToNewGroup()">+ å»ºç»„</button>
            <button class="tool-btn" style="background:#ff9500" onclick="moveSelectedToDefault()">â†© é€€ç»„</button>
            <button class="tool-btn" style="background:#ff3b30" onclick="clearSelection()">âŒ å–æ¶ˆ</button>
        </div>
        <div id="groups-container"></div>
    </div>

    <!-- 2. èƒŒè¯µ (ç»“æ„ä¼˜åŒ–ï¼ŒæŒ‰é’®åˆ†ç¦») -->
    <div id="page-quiz">
        <div class="card">
            
            <!-- å†…å®¹åŒº (è´Ÿè´£æ˜¾ç¤ºå›¾ç‰‡å’Œç­”æ¡ˆï¼Œå¦‚æœå†…å®¹å¤ªé•¿ä¼šè‡ªåŠ¨æ»šåŠ¨) -->
            <div class="card-body">
                <div class="img-box"><img id="q-img" src=""></div>
                <div id="ans-area" class="ans-box">
                    <div id="q-title" style="font-weight:bold; margin-bottom:10px; font-size:18px; color:#333;"></div>
                    <div class="origin-wrapper">
                        <span class="origin-label">æ ‡å‡†æ€:</span>
                        <div class="origin-img" style="display:flex;align-items:center;justify-content:center;overflow:hidden;">
                            <img id="ans-origin-img" src="" style="width:100%;height:100%;object-fit:contain;">
                        </div>
                    </div>
                    <div id="q-alg" class="ans-txt"></div>
                </div>
            </div>

            <!-- æŒ‰é’®åŒº (æ°¸è¿œå›ºå®šåœ¨åº•éƒ¨) -->
            <div class="btn-row">
                <button class="btn-act" style="background:#f39c12" onclick="showAns()">ğŸ‘€ ç­”æ¡ˆ</button>
                <button class="btn-act" style="background:#34c759" onclick="nextCard()">â¡ï¸ ä¸‹ä¸€ä¸ª</button>
            </div>
        </div>
        <p style="color:#999; font-size:12px; margin-top:10px; flex-shrink:0;">(å«éšæœºæ—‹è½¬)</p>
    </div>

    <script>
        const ollDb = Array.from({length: 57}, (_, i) => ({ id: i+1 }));
        const pllDb = Array.from({length: 21}, (_, i) => ({ id: "pll" + (i+1) }));
        const fullDb = [...ollDb, ...pllDb];

        let groups = [], algs = {}, settings = {}, currentSelectedIds = [];
        let isEditMode = false; 
        let dragSrcId = null, dragSrcGroupId = null;

        function init() {
            try {
                algs = JSON.parse(localStorage.getItem('cfop_algs_v7')) || {};
                const savedGroups = localStorage.getItem('cfop_groups_v7');
                settings = JSON.parse(localStorage.getItem('cfop_settings_v11')) || {};

                if (savedGroups) {
                    groups = JSON.parse(savedGroups);
                    const allIds = new Set();
                    groups.forEach(g => g.items.forEach(id => allIds.add(String(id))));
                    const missing = fullDb.filter(x => !allIds.has(String(x.id))).map(x => x.id);
                    if (missing.length > 0) {
                        let def = groups.find(g => g.id === 'default');
                        if (!def) { def={id:'default',name:'æœªåˆ†ç»„',items:[]}; groups.push(def); }
                        def.items.push(...missing);
                        saveData();
                    }
                } else {
                    groups = [{ id: "default", name: "æœªåˆ†ç»„", items: fullDb.map(x => x.id) }];
                }
            } catch(e) { console.error(e); }
            renderAll();
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const body = document.body;
            const btn = document.getElementById('btn-edit-mode');
            if (isEditMode) { body.classList.add('edit-mode-active'); btn.innerText = "âœ… ç¼–è¾‘æ¨¡å¼: ON"; } 
            else { body.classList.remove('edit-mode-active'); btn.innerText = "ğŸ”§ ç¼–è¾‘æ¨¡å¼: OFF"; }
        }

        function getItemInfo(id) {
            const set = settings[id] || {};
            const rot = set.rot || 0;
            let name = set.name;
            if (!name) { name = String(id).startsWith("pll") ? "PLL " + String(id).replace("pll", "") : "OLL " + id; }
            return { rot, name };
        }

        function renderAll() {
            const container = document.getElementById('groups-container');
            container.innerHTML = "";
            document.getElementById('sel-count').innerText = currentSelectedIds.length;

            groups.forEach((group) => {
                const section = document.createElement('div');
                section.className = 'group-section';
                section.dataset.groupId = group.id;

                const isAllSelected = group.items.length > 0 && group.items.every(id => currentSelectedIds.some(sid => String(sid) === String(id)));
                const selectBtnText = isAllSelected ? "å–æ¶ˆ" : "å…¨é€‰";
                const selectBtnClass = isAllSelected ? "btn-sm btn-deselect" : "btn-sm";

                let controlsHtml = `
                    <button class="btn-sm" onclick="moveGroupUp('${group.id}')">â¬†</button>
                    <button class="btn-sm" onclick="moveGroupDown('${group.id}')">â¬‡</button>
                    <button class="${selectBtnClass}" style="margin-left:5px" onclick="toggleGroupSelect('${group.id}')">${selectBtnText}</button>
                `;
                if (group.id !== 'default') controlsHtml += `<button class="btn-sm" style="color:red; border-color:#ffcccc;" onclick="deleteGroup('${group.id}')">åˆ </button>`;
                
                section.innerHTML = `<div class="group-header"><span class="group-title" onclick="renameGroup('${group.id}')">${group.name}</span><div>${controlsHtml}</div></div>`;

                const grid = document.createElement('div');
                grid.className = 'grid';
                grid.ondragover = (e) => handleDragOver(e, grid);
                grid.ondragleave = (e) => handleDragLeave(e, grid);
                grid.ondrop = (e) => handleDropOnGroup(e, group.id);

                if (group.items.length === 0) {
                    grid.innerHTML = `<div style="color:#ccc; grid-column:1/-1; padding:10px; font-size:12px;">(ç©º)</div>`;
                } else {
                    group.items.forEach(itemId => {
                        const itemDiv = document.createElement('div');
                        const isSel = currentSelectedIds.some(sid => String(sid) === String(itemId));
                        itemDiv.className = isSel ? 'item selected' : 'item';
                        itemDiv.id = `item-${itemId}`;
                        itemDiv.draggable = true;
                        itemDiv.dataset.id = itemId;
                        itemDiv.dataset.groupId = group.id;
                        itemDiv.ondragstart = (e) => handleDragStart(e, itemId, group.id);
                        itemDiv.ondragend = (e) => handleDragEnd(e);
                        itemDiv.ondrop = (e) => { e.stopPropagation(); handleDropOnItem(e, itemId, group.id); };

                        const showAlg = algs[itemId] || "";
                        const info = getItemInfo(itemId);
                        const imgFile = itemId + ".png";

                        itemDiv.innerHTML = `
                            <div onclick="toggleSelect('${itemId}')">
                                <div class="item-img-box">
                                    <img src="${imgFile}" style="transform: rotate(${info.rot}deg)" onerror="this.src='//via.placeholder.com/100?text=${itemId}'">
                                    <div class="btn-rotate" onclick="rotateItem(event, '${itemId}')">â†»</div>
                                </div>
                            </div>
                            <span class="name-tag" onclick="renameItem('${itemId}')" title="éœ€å¼€å¯ç¼–è¾‘æ¨¡å¼">${info.name}</span>
                            <textarea class="alg-input" onchange="saveAlg('${itemId}', this.value)" placeholder="å…¬å¼">${showAlg}</textarea>
                        `;
                        grid.appendChild(itemDiv);
                    });
                }
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        // æ—‹è½¬
        function rotateItem(e, id) {
            e.stopPropagation();
            if (!isEditMode) return; 
            if (!settings[id]) settings[id] = {};
            let currentRot = settings[id].rot || 0;
            currentRot = (currentRot + 90) % 360;
            settings[id].rot = currentRot;
            saveSettings();
            renderAll();
        }

        // æ”¹å
        function renameItem(id) {
            if (!isEditMode) return; 
            const current = getItemInfo(id).name;
            const newName = prompt("ä¸ºè¿™ä¸ªå…¬å¼èµ·ä¸ªåå­—ï¼š", current);
            if (newName !== null) {
                if (!settings[id]) settings[id] = {};
                settings[id].name = newName;
                saveSettings();
                renderAll();
            }
        }

        function saveSettings() { localStorage.setItem('cfop_settings_v11', JSON.stringify(settings)); }

        // æ‹–æ‹½
        function handleDragStart(e, id, groupId) { dragSrcId = id; dragSrcGroupId = groupId; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); setTimeout(() => e.target.style.opacity='0.4', 0); }
        function handleDragEnd(e) { e.target.style.opacity='1'; document.querySelectorAll('.drag-over-group').forEach(el => el.classList.remove('drag-over-group')); }
        function handleDragOver(e, el) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; if (el.classList.contains('grid')) el.parentElement.classList.add('drag-over-group'); }
        function handleDragLeave(e, el) { if (el.classList.contains('grid')) el.parentElement.classList.remove('drag-over-group'); }
        function handleDropOnItem(e, targetId, targetGroupId) { e.preventDefault(); if (dragSrcId === null || dragSrcId === targetId) return; moveItemLogic(dragSrcId, dragSrcGroupId, targetId, targetGroupId); }
        function handleDropOnGroup(e, targetGroupId) { e.preventDefault(); if (dragSrcId === null) return; moveItemLogic(dragSrcId, dragSrcGroupId, null, targetGroupId); }
        function moveItemLogic(itemId, srcGroupId, targetItemId, targetGroupId) {
            if (!isNaN(itemId) && !String(itemId).startsWith('pll')) itemId = Number(itemId);
            const srcGroup = groups.find(g => g.id === srcGroupId);
            const targetGroup = groups.find(g => g.id === targetGroupId);
            srcGroup.items = srcGroup.items.filter(x => String(x) !== String(itemId));
            if (targetItemId) { 
                const idx = targetGroup.items.findIndex(x => String(x) === String(targetItemId));
                targetGroup.items.splice(idx, 0, itemId); 
            }
            else { targetGroup.items.push(itemId); }
            saveData(); renderAll();
        }

        function moveGroupUp(id) { const i = groups.findIndex(g=>g.id===id); if(i>0) { [groups[i],groups[i-1]]=[groups[i-1],groups[i]]; saveData(); renderAll(); } }
        function moveGroupDown(id) { const i = groups.findIndex(g=>g.id===id); if(i<groups.length-1) { [groups[i],groups[i+1]]=[groups[i+1],groups[i]]; saveData(); renderAll(); } }
        
        function moveSelectedToNewGroup() { if(!currentSelectedIds.length) return alert("è¯·å…ˆå‹¾é€‰"); const n=prompt("æ–°åˆ†ç»„åï¼š"); if(!n) return; groups.forEach(g=>g.items=g.items.filter(id=>!currentSelectedIds.some(sid=>String(sid)===String(id)))); groups.unshift({id:"g_"+Date.now(), name:n, items:[...currentSelectedIds]}); currentSelectedIds=[]; saveData(); renderAll(); }
        function moveSelectedToDefault() { if(!currentSelectedIds.length) return alert("è¯·å‹¾é€‰"); groups.forEach(g=>{if(g.id!=='default')g.items=g.items.filter(id=>!currentSelectedIds.some(sid=>String(sid)===String(id)))}); const d=groups.find(g=>g.id==='default'); d.items=[...new Set([...d.items,...currentSelectedIds])]; currentSelectedIds=[]; saveData(); renderAll(); }
        
        function toggleSelect(id) { 
            if (!isNaN(id) && !String(id).startsWith('pll')) id = Number(id);
            if(currentSelectedIds.some(x => String(x) === String(id))) 
                currentSelectedIds = currentSelectedIds.filter(x => String(x) !== String(id));
            else 
                currentSelectedIds.push(id); 
            renderAll(); 
        }
        function toggleGroupSelect(gid) {
            const g = groups.find(x => x.id === gid); if(!g) return;
            const isAll = g.items.length > 0 && g.items.every(id => currentSelectedIds.some(sid => String(sid) === String(id)));
            if (isAll) currentSelectedIds = currentSelectedIds.filter(id => !g.items.some(gid => String(gid) === String(id)));
            else {
                const newItems = g.items.filter(id => !currentSelectedIds.some(sid => String(sid) === String(id)));
                currentSelectedIds.push(...newItems);
            }
            renderAll();
        }
        function clearSelection() { currentSelectedIds=[]; renderAll(); }
        function renameGroup(id) { if(id==='default')return; const g=groups.find(x=>x.id===id); const v=prompt("ä¿®æ”¹åç§°",g.name); if(v){g.name=v;saveData();renderAll();} }
        function deleteGroup(id) { if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ"))return; const g=groups.find(x=>x.id===id); const d=groups.find(x=>x.id==='default'); d.items=[...new Set([...d.items,...g.items])]; groups=groups.filter(x=>x.id!==id); saveData(); renderAll(); }
        
        function exportData() { const b=new Blob([JSON.stringify({version:"12.1", date:new Date().toLocaleString(), groups, algs, settings},null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="CFOP_Backup.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function importData(input) { 
            const f=input.files[0]; if(!f)return; 
            const r=new FileReader(); 
            r.onload=e=>{
                try{
                    const d=JSON.parse(e.target.result);
                    if(d.groups){
                        if(confirm("æ¢å¤æ•°æ®ï¼Ÿ")){
                            groups=d.groups; algs=d.algs||{}; settings=d.settings||{};
                            saveData(); localStorage.setItem('cfop_algs_v7', JSON.stringify(algs)); saveSettings();
                            renderAll(); alert("å®Œæˆ");
                        }
                    }
                } catch(err){alert("æ–‡ä»¶é”™è¯¯");}
            }; 
            r.readAsText(f); input.value=""; 
        }
        
        function saveAlg(id,v) { algs[id]=v; localStorage.setItem('cfop_algs_v7',JSON.stringify(algs)); }
        function saveData() { localStorage.setItem('cfop_groups_v7',JSON.stringify(groups)); }

        // èƒŒè¯µ
        function switchPage(p) { document.getElementById('page-manage').style.display = p===1 ? 'block' : 'none'; document.getElementById('page-quiz').style.display = p===2 ? 'flex' : 'none'; document.getElementById('nav-1').className = p===1 ? 'nav-btn active' : 'nav-btn'; document.getElementById('nav-2').className = p===2 ? 'nav-btn active' : 'nav-btn'; if(p===2) nextCard(); }
        function nextCard() {
            if(currentSelectedIds.length === 0) { alert("è¯·å…ˆå‹¾é€‰å›¾ç‰‡"); switchPage(1); return; }
            document.getElementById('ans-area').style.display = 'none';
            
            // ç¡®ä¿æ»šåŠ¨æ¡å›åˆ°é¡¶éƒ¨
            document.querySelector('.card-body').scrollTop = 0;

            const randId = currentSelectedIds[Math.floor(Math.random() * currentSelectedIds.length)];
            const alg = algs[randId] || "æœªè®¾ç½®å…¬å¼";
            const info = getItemInfo(randId);
            const baseRot = info.rot || 0;

            const img = document.getElementById('q-img');
            img.style.transition = 'none'; img.style.transform = 'rotate(0deg)'; 
            img.src = randId + ".png"; 
            void img.offsetWidth;
            const randomAdd = Math.floor(Math.random() * 4) * 90;
            const finalDeg = baseRot + randomAdd;
            img.style.transform = `rotate(${finalDeg}deg)`;
            
            document.getElementById('q-title').innerText = `${info.name}` + (randomAdd?` (è½¬${randomAdd}Â°)`:'');
            document.getElementById('q-alg').innerText = alg;
            
            const originImg = document.getElementById('ans-origin-img');
            originImg.src = randId + ".png";
            originImg.style.transform = `rotate(${baseRot}deg)`;
        }
        function showAns() { 
            document.getElementById('ans-area').style.display = 'block'; 
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œæ–¹ä¾¿çœ‹ç­”æ¡ˆï¼ˆå¦‚æœå±å¹•å¾ˆå°ï¼‰
            setTimeout(() => {
                const cardBody = document.querySelector('.card-body');
                cardBody.scrollTo({ top: cardBody.scrollHeight, behavior: 'smooth' });
            }, 10);
        }

        init();
    </script>
</body>
</html>