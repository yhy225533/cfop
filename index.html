<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFOP å…¨é€‰ä¼˜åŒ–ç‰ˆ (v7.2)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f7; color: #333; }
        
        /* ç¦æ­¢å›¾ç‰‡æ‹–æ‹½ */
        img { -webkit-user-drag: none; user-select: none; }

        /* === å¯¼èˆªæ  === */
        .navbar {
            position: sticky; top: 0; z-index: 999;
            background: rgba(255,255,255,0.98);
            padding: 10px 20px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .nav-center { display: flex; gap: 10px; }
        .nav-btn { padding: 8px 20px; border-radius: 6px; border: 1px solid #ccc; background: white; cursor: pointer; font-weight: bold; }
        .nav-btn.active { background: #007aff; color: white; border-color: #007aff; }
        .backup-area { display: flex; gap: 8px; }
        .btn-backup { font-size: 12px; padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; background: #f9f9f9; cursor: pointer; }

        /* === å·¥å…·æ  === */
        .toolbar {
            display: flex; gap: 10px; justify-content: center; align-items: center; padding: 12px; background: #fff;
            border-bottom: 1px dashed #ddd; flex-wrap: wrap;
        }
        .tool-btn { color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .group-select { padding: 7px; border-radius: 4px; border: 1px solid #ccc; max-width: 150px; }
        .sel-info { font-size: 13px; color: #666; font-weight: bold; margin-right: 10px;}

        /* === æ•´ç†é¡µ === */
        #page-manage { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .group-section {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .group-section.drag-over-group { background-color: #e3f2fd; border: 2px dashed #2196f3; }

        .group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; margin-bottom: 15px;
        }
        .group-title { font-size: 18px; font-weight: bold; color: #333; cursor: pointer; border-bottom: 1px dashed #ccc; }
        .btn-sm { padding: 4px 8px; font-size: 12px; border: 1px solid #eee; background: #f9f9f9; border-radius: 4px; cursor: pointer; margin-left: 4px; }
        
        /* é€‰ä¸­çŠ¶æ€ä¸‹çš„å…¨é€‰æŒ‰é’®å˜æˆçº¢è‰²æç¤º */
        .btn-deselect { color: #d63031; border-color: #d63031; background: #fff5f5; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; min-height: 50px; }
        
        .item {
            border: 2px solid transparent; border-radius: 8px; padding: 10px; text-align: center; cursor: grab; 
            background: #fff; transition: transform 0.1s;
        }
        .item:active { cursor: grabbing; }
        .item.selected { border-color: #34c759; background: #eaffea; }
        .item.dragging { opacity: 0.4; border: 2px dashed #999; transform: scale(0.95); }
        .item img { width: 100%; height: auto; display: block; pointer-events: none; margin-bottom: 5px;}
        
        .alg-input {
            width: 90%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px; font-weight: 500; color: #004085;
            border: 1px solid #eee; background: #fafafa; border-radius: 6px; padding: 6px;
            text-align: center; letter-spacing: 1px;
        }
        .alg-input:focus { background: white; border-color: #007aff; outline: none; }

        /* === èƒŒè¯µé¡µ === */
        #page-quiz { display: none; min-height: 85vh; flex-direction: column; align-items: center; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        
        .img-box { width: 250px; height: 250px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; }
        .img-box img { width: 100%; height: 100%; object-fit: contain; }
        
        .ans-box { display: none; background: #f0f4f8; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; border: 1px solid #dbeafe; }
        
        .origin-img-wrapper { margin: 10px auto; width: 100px; height: 100px; border: 2px solid #fff; border-radius: 8px; background: #fff; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .origin-img-wrapper img { width: 100%; height: 100%; object-fit: contain; }
        .origin-label { font-size: 13px; color: #7f8c8d; margin-bottom: 5px; }

        .ans-txt { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-weight: 600; color: #003366; font-size: 28px; line-height: 1.5; 
            letter-spacing: 2px; word-break: break-word; white-space: pre-wrap; 
            text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #dae1e7; 
        }
        
        .btn-row { display: flex; gap: 15px; margin-top: 10px;}
        .btn-act { flex: 1; padding: 15px; border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 18px; cursor: pointer; transition: opacity 0.2s; }
        .btn-act:active { opacity: 0.8; }

    </style>
</head>
<body>

    <div class="navbar">
        <div style="font-weight:bold; color:#007aff; font-size:18px;">CFOP V7.2</div>
        <div class="nav-center">
            <button id="nav-1" class="nav-btn active" onclick="switchPage(1)">1. æ•´ç†</button>
            <button id="nav-2" class="nav-btn" onclick="switchPage(2)">2. èƒŒè¯µ</button>
        </div>
        <div class="backup-area">
            <button class="btn-backup" onclick="exportData()">ğŸ’¾ å¤‡ä»½</button>
            <button class="btn-backup" onclick="document.getElementById('file-in').click()">ğŸ“‚ æ¢å¤</button>
            <input type="file" id="file-in" style="display:none" accept=".json" onchange="importData(this)">
        </div>
    </div>

    <!-- 1. æ•´ç† -->
    <div id="page-manage">
        <div class="toolbar">
            <div class="sel-info">é€‰ä¸­ <span id="sel-count" style="color:#007aff; font-weight:bold;">0</span></div>
            <button class="tool-btn" style="background:#007aff" onclick="moveSelectedToNewGroup()">+ æ–°å»ºåˆ†ç»„</button>
            <div style="width:1px; height:20px; background:#ddd; margin:0 10px;"></div>
            <select id="target-group-select" class="group-select"><option value="">-- ç§»åŠ¨åˆ°... --</option></select>
            <button class="tool-btn" style="background:#34c759" onclick="moveToExistingGroup()">ç§»åŠ¨</button>
            <div style="width:1px; height:20px; background:#ddd; margin:0 10px;"></div>
            <button class="tool-btn" style="background:#ff9500" onclick="moveSelectedToDefault()">â†©ï¸ å›æœªåˆ†ç»„</button>
            <button class="tool-btn" style="background:#ff3b30" onclick="clearSelection()">âŒ å–æ¶ˆ</button>
        </div>
        
        <p style="text-align:center; font-size:12px; color:#999; margin-top:5px;">æç¤ºï¼šæŒ‰ä½å›¾ç‰‡å¯ç›´æ¥æ‹–æ‹½æ’åºï¼Œæˆ–æ‹–å…¥å…¶ä»–åˆ†ç»„</p>
        <div id="groups-container"></div>
    </div>

    <!-- 2. èƒŒè¯µ -->
    <div id="page-quiz">
        <div class="card">
            <div class="img-box"><img id="q-img" src=""></div>
            <div id="ans-area" class="ans-box">
                <div id="q-title" style="font-weight:bold; margin-bottom:10px; font-size:18px; color:#333;"></div>
                <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                    <div class="origin-label">æ ‡å‡†æ–¹å‘ï¼š</div>
                    <div class="origin-img-wrapper"><img id="ans-origin-img" src=""></div>
                </div>
                <div id="q-alg" class="ans-txt"></div>
            </div>
            <div class="btn-row">
                <button class="btn-act" style="background:#f39c12" onclick="showAns()">ğŸ‘€ ç­”æ¡ˆ</button>
                <button class="btn-act" style="background:#34c759" onclick="nextCard()">â¡ï¸ ä¸‹ä¸€ä¸ª</button>
            </div>
        </div>
        <p style="color:#999; font-size:12px; margin-top:20px;">(éšæœºæ—‹è½¬ æ— åŠ¨ç”»ç‰ˆ)</p>
    </div>

    <script>
        // === 1. åˆå§‹åŒ– ===
        const baseDb = Array.from({length: 57}, (_, i) => ({ id: i+1, alg: "" }));
        let groups = [], algs = {}, currentSelectedIds = [], dragSrcId = null, dragSrcGroupId = null;

        function init() {
            try {
                algs = JSON.parse(localStorage.getItem('cfop_algs_v7')) || {};
                const savedGroups = localStorage.getItem('cfop_groups_v7');
                if (savedGroups) groups = JSON.parse(savedGroups);
                else groups = [{ id: "default", name: "æœªåˆ†ç»„", items: baseDb.map(x => x.id) }];
            } catch(e) {}
            renderAll();
        }

        // === 2. æ¸²æŸ“ ===
        function renderAll() {
            const container = document.getElementById('groups-container');
            container.innerHTML = "";
            document.getElementById('sel-count').innerText = currentSelectedIds.length;
            updateGroupSelect();

            groups.forEach((group) => {
                const section = document.createElement('div');
                section.className = 'group-section';
                section.dataset.groupId = group.id;

                // åˆ¤æ–­è¯¥ç»„æ˜¯å¦å·²å…¨é€‰
                const isAllSelected = group.items.length > 0 && group.items.every(id => currentSelectedIds.includes(id));
                const selectBtnText = isAllSelected ? "å–æ¶ˆ" : "å…¨é€‰";
                const selectBtnClass = isAllSelected ? "btn-sm btn-deselect" : "btn-sm";

                let controlsHtml = `
                    <button class="btn-sm" onclick="moveGroupUp('${group.id}')">â¬†ï¸</button>
                    <button class="btn-sm" onclick="moveGroupDown('${group.id}')">â¬‡ï¸</button>
                    <button class="${selectBtnClass}" style="margin-left:10px" onclick="toggleGroupSelect('${group.id}')">${selectBtnText}</button>
                `;
                if (group.id !== 'default') controlsHtml += `<button class="btn-sm" style="color:red" onclick="deleteGroup('${group.id}')">åˆ é™¤</button>`;
                
                section.innerHTML = `<div class="group-header"><span class="group-title" onclick="renameGroup('${group.id}')">${group.name}</span><div>${controlsHtml}</div></div>`;

                const grid = document.createElement('div');
                grid.className = 'grid';
                grid.ondragover = (e) => handleDragOver(e, grid);
                grid.ondragleave = (e) => handleDragLeave(e, grid);
                grid.ondrop = (e) => handleDropOnGroup(e, group.id);

                if (group.items.length === 0) {
                    grid.innerHTML = `<div style="color:#ccc; grid-column:1/-1; padding:10px; pointer-events:none;">(æ‹–å…¥å›¾ç‰‡åˆ°è¿™é‡Œ)</div>`;
                } else {
                    group.items.forEach(itemId => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = currentSelectedIds.includes(itemId) ? 'item selected' : 'item';
                        itemDiv.id = `item-${itemId}`;
                        itemDiv.draggable = true;
                        itemDiv.dataset.id = itemId;
                        itemDiv.dataset.groupId = group.id;
                        itemDiv.ondragstart = (e) => handleDragStart(e, itemId, group.id);
                        itemDiv.ondragend = (e) => handleDragEnd(e);
                        itemDiv.ondrop = (e) => { e.stopPropagation(); handleDropOnItem(e, itemId, group.id); };

                        const showAlg = algs[itemId] || "";
                        itemDiv.innerHTML = `
                            <div onclick="toggleSelect(${itemId})"><img src="${itemId}.png" onerror="this.src='//via.placeholder.com/100?text=${itemId}'"></div>
                            <textarea class="alg-input" onchange="saveAlg(${itemId}, this.value)" placeholder="ç‚¹å‡»è¾“å…¥å…¬å¼">${showAlg}</textarea>
                            <div style="font-size:12px;color:#999;margin-top:2px;">OLL ${itemId}</div>
                        `;
                        grid.appendChild(itemDiv);
                    });
                }
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        // === 3. æ‹–æ‹½é€»è¾‘ ===
        function handleDragStart(e, id, groupId) { dragSrcId = id; dragSrcGroupId = groupId; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); setTimeout(() => e.target.classList.add('dragging'), 0); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.drag-over-group').forEach(el => el.classList.remove('drag-over-group')); }
        function handleDragOver(e, el) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; if (el.classList.contains('grid')) el.parentElement.classList.add('drag-over-group'); }
        function handleDragLeave(e, el) { if (el.classList.contains('grid')) el.parentElement.classList.remove('drag-over-group'); }
        function handleDropOnItem(e, targetId, targetGroupId) { e.preventDefault(); if (dragSrcId === null || dragSrcId === targetId) return; moveItemLogic(dragSrcId, dragSrcGroupId, targetId, targetGroupId); }
        function handleDropOnGroup(e, targetGroupId) { e.preventDefault(); if (dragSrcId === null) return; moveItemLogic(dragSrcId, dragSrcGroupId, null, targetGroupId); }
        function moveItemLogic(itemId, srcGroupId, targetItemId, targetGroupId) {
            const srcGroup = groups.find(g => g.id === srcGroupId);
            const targetGroup = groups.find(g => g.id === targetGroupId);
            srcGroup.items = srcGroup.items.filter(x => x !== itemId);
            if (targetItemId) { const idx = targetGroup.items.indexOf(targetItemId); targetGroup.items.splice(idx, 0, itemId); }
            else { targetGroup.items.push(itemId); }
            saveData(); renderAll();
        }

        // === 4. å¸¸è§„é€»è¾‘ ===
        function moveGroupUp(id) { const i = groups.findIndex(g=>g.id===id); if(i>0) { [groups[i],groups[i-1]]=[groups[i-1],groups[i]]; saveData(); renderAll(); } }
        function moveGroupDown(id) { const i = groups.findIndex(g=>g.id===id); if(i<groups.length-1) { [groups[i],groups[i+1]]=[groups[i+1],groups[i]]; saveData(); renderAll(); } }
        function updateGroupSelect() { const s = document.getElementById('target-group-select'); s.innerHTML='<option value="">-- ç§»åŠ¨åˆ°... --</option>'; groups.forEach(g => { if(g.id!=='default') { const o=document.createElement('option'); o.value=g.id; o.innerText=g.name; s.appendChild(o); }}); }
        function moveSelectedToNewGroup() { if(!currentSelectedIds.length) return alert("è¯·å‹¾é€‰"); const n=prompt("æ–°åˆ†ç»„åï¼š"); if(!n) return; groups.forEach(g=>g.items=g.items.filter(id=>!currentSelectedIds.includes(id))); groups.unshift({id:"g_"+Date.now(), name:n, items:[...currentSelectedIds]}); currentSelectedIds=[]; saveData(); renderAll(); }
        function moveToExistingGroup() { const tid=document.getElementById('target-group-select').value; if(!tid||!currentSelectedIds.length) return alert("è¯·é€‰æ‹©"); groups.forEach(g=>g.items=g.items.filter(id=>!currentSelectedIds.includes(id))); const t=groups.find(g=>g.id===tid); if(t) t.items=[...new Set([...t.items,...currentSelectedIds])].sort((a,b)=>a-b); currentSelectedIds=[]; saveData(); renderAll(); }
        function moveSelectedToDefault() { if(!currentSelectedIds.length) return alert("è¯·å‹¾é€‰"); groups.forEach(g=>{if(g.id!=='default')g.items=g.items.filter(id=>!currentSelectedIds.includes(id))}); const d=groups.find(g=>g.id==='default'); d.items=[...new Set([...d.items,...currentSelectedIds])].sort((a,b)=>a-b); currentSelectedIds=[]; saveData(); renderAll(); }
        function exportData() { const b=new Blob([JSON.stringify({version:"7.2", date:new Date().toLocaleString(), groups, algs},null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="CFOP_Backup.json"; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function importData(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.groups){if(confirm("æ¢å¤å¤‡ä»½?")){groups=d.groups;algs=d.algs;saveData();renderAll();alert("æˆåŠŸ");}}}catch(err){alert("é”™è¯¯");}}; r.readAsText(f); input.value=""; }
        function toggleSelect(id) { if(currentSelectedIds.includes(id)) currentSelectedIds=currentSelectedIds.filter(x=>x!==id); else currentSelectedIds.push(id); renderStyle(); }
        
        function renderStyle() {
            document.getElementById('sel-count').innerText=currentSelectedIds.length;
            // å› ä¸ºæŒ‰é’®æ–‡å­—å˜äº†ï¼Œéœ€è¦æ›´æ–°å…¨é€‰æŒ‰é’®çš„çŠ¶æ€ï¼Œè¿™é‡Œç®€å•èµ·è§è¿˜æ˜¯å…¨é‡åˆ·æ–°renderAllå®‰å…¨ï¼Œä½†ä¸ºäº†æ€§èƒ½åªæ›´æ–°æ ·å¼
            // å‘ç°åªæ›´æ–°æ ·å¼ä¼šå¯¼è‡´æŒ‰é’®æ–‡å­—ä¸æ›´æ–°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¿…é¡»é‡æ–°æ¸²æŸ“æŒ‰é’®æ–‡å­—ï¼Œæˆ–è€…ç›´æ¥renderAll
            // è€ƒè™‘åˆ°æ€§èƒ½ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç›´æ¥è°ƒç”¨renderAllå§ï¼Œåæ­£57ä¸ªå›¾å¾ˆå¿«
            renderAll(); 
        }
        
        function clearSelection() { currentSelectedIds=[]; renderAll(); }
        
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šå…¨é€‰/åé€‰é€»è¾‘ ---
        function toggleGroupSelect(gid) {
            const g = groups.find(x => x.id === gid);
            if(!g) return;
            
            // æ£€æŸ¥è¯¥ç»„æ˜¯å¦å·²å…¨éƒ¨è¢«é€‰ä¸­
            const isAllSelected = g.items.length > 0 && g.items.every(id => currentSelectedIds.includes(id));
            
            if (isAllSelected) {
                // å¦‚æœå·²å…¨é€‰ï¼Œåˆ™ä»é€‰ä¸­åˆ—è¡¨ä¸­å‰”é™¤è¯¥ç»„æ‰€æœ‰é¡¹ï¼ˆåé€‰ï¼‰
                currentSelectedIds = currentSelectedIds.filter(id => !g.items.includes(id));
            } else {
                // å¦åˆ™ï¼Œå°†è¯¥ç»„æœªé€‰ä¸­çš„é¡¹æ·»åŠ è¿›å»ï¼ˆå…¨é€‰ï¼‰
                const newItems = g.items.filter(id => !currentSelectedIds.includes(id));
                currentSelectedIds = [...currentSelectedIds, ...newItems];
            }
            renderAll(); // åˆ·æ–°ç•Œé¢
        }

        function renameGroup(id) { if(id==='default')return; const g=groups.find(x=>x.id===id); const v=prompt("ä¿®æ”¹åç§°",g.name); if(v){g.name=v;saveData();renderAll();} }
        function deleteGroup(id) {
            if(!confirm("åˆ é™¤åˆ†ç»„ï¼Ÿå›¾ç‰‡å›é€€åˆ°æœªåˆ†ç»„"))return;
            const g=groups.find(x=>x.id===id); const d=groups.find(x=>x.id==='default');
            d.items=[...new Set([...d.items,...g.items])].sort((a,b)=>a-b);
            groups=groups.filter(x=>x.id!==id); saveData(); renderAll();
        }
        function saveAlg(id,v) { algs[id]=v; localStorage.setItem('cfop_algs_v7',JSON.stringify(algs)); }
        function saveData() { localStorage.setItem('cfop_groups_v7',JSON.stringify(groups)); }

        // === èƒŒè¯µ ===
        function switchPage(p) { document.getElementById('page-manage').style.display = p===1 ? 'block' : 'none'; document.getElementById('page-quiz').style.display = p===2 ? 'flex' : 'none'; document.getElementById('nav-1').className = p===1 ? 'nav-btn active' : 'nav-btn'; document.getElementById('nav-2').className = p===2 ? 'nav-btn active' : 'nav-btn'; if(p===2) nextCard(); }
        function nextCard() {
            if(currentSelectedIds.length === 0) { alert("è¯·å…ˆå‹¾é€‰å›¾ç‰‡"); switchPage(1); return; }
            document.getElementById('ans-area').style.display = 'none';
            const randId = currentSelectedIds[Math.floor(Math.random() * currentSelectedIds.length)];
            const alg = algs[randId] || "ç‚¹å‡»æ•´ç†é¡µè¾“å…¥å…¬å¼";
            const img = document.getElementById('q-img');
            img.style.transition = 'none'; img.style.transform = 'rotate(0deg)'; img.src = randId + ".png"; void img.offsetWidth;
            const deg = Math.floor(Math.random() * 4) * 90;
            img.style.transform = `rotate(${deg}deg)`;
            document.getElementById('q-title').innerText = `OLL ${randId}` + (deg?` (è½¬${deg}Â°)`:'');
            document.getElementById('q-alg').innerText = alg;
            document.getElementById('ans-origin-img').src = randId + ".png";
        }
        function showAns() { document.getElementById('ans-area').style.display = 'block'; }

        init();
    </script>
</body>
</html>